<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>WebHook Tester</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1f2937;
      --light: #f9fafb;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      opacity: 0.9;
      font-size: 16px;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title svg {
      width: 20px;
      height: 20px;
    }
    
    .btn-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 480px) {
      .btn-group {
        grid-template-columns: 1fr;
      }
    }
    
    button {
      padding: 14px 16px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-dark {
      background: var(--dark);
      color: white;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .status.connected {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .status.disconnected {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    .status.pending {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    
    .log-container {
      background: var(--light);
      border-radius: 12px;
      padding: 16px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
    }
    
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .log-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
    }
    
    .log-clear {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    
    .log-clear:hover {
      background: #e5e7eb;
    }
    
    .log-entry {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 6px;
      background: white;
      border-left: 4px solid var(--primary);
      word-break: break-all;
    }
    
    .log-entry.get {
      border-left-color: var(--success);
    }
    
    .log-entry.post {
      border-left-color: var(--warning);
    }
    
    .log-entry.error {
      border-left-color: var(--danger);
    }
    
    .data-display {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      border: 1px dashed #cbd5e1;
    }
    
    .data-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .data-item:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }
    
    .data-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .data-value {
      font-size: 14px;
      color: var(--dark);
      font-weight: 600;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #4b5563;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    .loading {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .notification.success {
      border-left: 4px solid var(--success);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger);
    }
    
    .notification.warning {
      border-left: 4px solid var(--warning);
    }
    
    .notification-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ”— WebHook Tester</h1>
      <p>Test GET & POST requests between WebApp and Bot</p>
    </div>
    
    <div class="card">
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
        </svg>
        <span>Connection Status</span>
      </div>
      
      <div class="status" id="status">
        <div class="spinner"></div>
        <span>Checking connection...</span>
      </div>
      
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
        </svg>
        <span>GET Request (Load Data)</span>
      </div>
      
      <div class="btn-group">
        <button class="btn-success" onclick="testGet('simple')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          Simple GET
        </button>
        
        <button class="btn-primary" onclick="testGet('full')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          Load User Data
        </button>
      </div>
      
      <div id="dataDisplay" class="data-display" style="display: none;">
        <!-- Data will be displayed here -->
      </div>
    </div>
    
    <div class="card">
      <div class="section-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
        <span>POST Request (Send Data)</span>
      </div>
      
      <div class="input-group">
        <label for="balanceInput">Update Balance</label>
        <input type="number" id="balanceInput" placeholder="Enter new balance" value="100">
      </div>
      
      <div class="btn-group">
        <button class="btn-warning" onclick="testPost('update_balance')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
            <path d="m9 12 2 2 4-4"/>
          </svg>
          Update Balance
        </button>
        
        <button class="btn-dark" onclick="testPost('get_data')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 0 1 9-9"/>
          </svg>
          Request Data
        </button>
      </div>
      
      <div class="input-group" style="margin-top: 20px;">
        <label for="messageInput">Send Message to Bot</label>
        <textarea id="messageInput" placeholder="Type your message...">Hello from WebApp! This is a test message.</textarea>
      </div>
      
      <button class="btn-primary" onclick="testPost('send_message')" style="width: 100%; margin-top: 10px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13"/>
          <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
        Send Message to Bot
      </button>
    </div>
    
    <div class="card">
      <div class="log-header">
        <div class="log-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Activity Log
        </div>
        <button class="log-clear" onclick="clearLogs()">Clear All</button>
      </div>
      
      <div class="log-container" id="logContainer">
        <!-- Logs will appear here -->
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification">
    <div class="notification-icon"></div>
    <span id="notificationText"></span>
  </div>
  
  <script>
    // Global variables
    let syncUrl = null;
    let connectionStatus = 'pending';
    const tg = window.Telegram?.WebApp;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      syncUrl = urlParams.get('sync');
      const botName = urlParams.get('botName') || 'WebHook Tester';
      const userId = urlParams.get('userId');
      
      // Update title
      document.title = `${botName} - WebHook Test`;
      
      // Initialize Telegram WebApp
      if (tg) {
        try {
          tg.ready();
          tg.expand();
          tg.setHeaderColor('#6366f1');
          tg.setBackgroundColor('#667eea');
        } catch (e) {
          console.warn('Telegram WebApp init failed:', e);
        }
      }
      
      // Test connection
      testConnection();
      
      // Add initial log
      addLog('WebApp initialized', 'info');
      addLog(`Bot: ${botName}`, 'info');
      addLog(`User ID: ${userId || 'Unknown'}`, 'info');
      addLog(`Sync URL: ${syncUrl ? 'Found' : 'Missing'}`, syncUrl ? 'success' : 'error');
    });
    
    // Test connection to bot
    async function testConnection() {
      if (!syncUrl) {
        updateStatus('disconnected', 'Missing sync URL');
        showNotification('âŒ Please open from bot using /start', 'error');
        return;
      }
      
      updateStatus('pending', 'Testing connection...');
      addLog('Testing connection to bot...', 'info');
      
      try {
        // Simple GET request to test connection
        const response = await fetch(syncUrl, {
          method: 'GET'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          updateStatus('connected', 'Connected to bot');
          addLog('âœ… Connection successful!', 'success');
          showNotification('âœ… Connected to bot successfully!', 'success');
          
          // Display some data
          displayData(data);
        } else {
          throw new Error(data.error || 'Connection failed');
        }
        
      } catch (error) {
        updateStatus('disconnected', `Connection failed: ${error.message}`);
        addLog(`âŒ Connection failed: ${error.message}`, 'error');
        showNotification(`âŒ Connection failed: ${error.message}`, 'error');
      }
    }
    
    // Test GET request
    async function testGet(type) {
      if (!syncUrl) {
        showNotification('âŒ No sync URL available', 'error');
        return;
      }
      
      const button = event?.target?.closest('button');
      if (button) button.disabled = true;
      
      addLog(`Starting ${type} GET request...`, 'info');
      
      try {
        const response = await fetch(syncUrl, {
          method: 'GET'
        });
        
        addLog(`GET Response: HTTP ${response.status}`, 'get');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        addLog(`GET Success: ${data.message || 'Data loaded'}`, 'get');
        
        // Display the data
        displayData(data);
        
        // Show notification
        showNotification(`âœ… ${data.message || 'GET request successful'}`, 'success');
        
        // Haptic feedback
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('success');
        }
        
      } catch (error) {
        addLog(`âŒ GET Failed: ${error.message}`, 'error');
        showNotification(`âŒ GET Failed: ${error.message}`, 'error');
        
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('error');
        }
        
      } finally {
        if (button) {
          setTimeout(() => {
            button.disabled = false;
          }, 1000);
        }
      }
    }
    
    // Test POST request
    async function testPost(action) {
      if (!syncUrl) {
        showNotification('âŒ No sync URL available', 'error');
        return;
      }
      
      const button = event?.target?.closest('button');
      if (button) button.disabled = true;
      
      // Prepare data based on action
      let data = {};
      
      switch (action) {
        case 'update_balance':
          const balance = document.getElementById('balanceInput').value;
          if (!balance || isNaN(balance)) {
            showNotification('âŒ Please enter a valid balance', 'error');
            if (button) button.disabled = false;
            return;
          }
          data = { balance: parseInt(balance, 10) };
          break;
          
        case 'send_message':
          const message = document.getElementById('messageInput').value;
          if (!message.trim()) {
            showNotification('âŒ Please enter a message', 'error');
            if (button) button.disabled = false;
            return;
          }
          data = { message: message };
          break;
          
        case 'get_data':
          data = { request: 'user_data' };
          break;
          
        default:
          data = { test: 'random_data', timestamp: Date.now() };
      }
      
      addLog(`Starting POST request: ${action}`, 'info');
      addLog(`POST Data: ${JSON.stringify(data)}`, 'post');
      
      try {
        const response = await fetch(syncUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            data: data
          })
        });
        
        addLog(`POST Response: HTTP ${response.status}`, 'post');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        addLog(`POST Success: ${result.message || 'Action completed'}`, 'post');
        
        // Show notification
        showNotification(`âœ… ${result.message || 'POST request successful'}`, 'success');
        
        // Haptic feedback
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('success');
        }
        
        // If this was a get_data action, display the data
        if (action === 'get_data' && result.data) {
          displayData(result);
        }
        
      } catch (error) {
        addLog(`âŒ POST Failed: ${error.message}`, 'error');
        showNotification(`âŒ POST Failed: ${error.message}`, 'error');
        
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('error');
        }
        
      } finally {
        if (button) {
          setTimeout(() => {
            button.disabled = false;
          }, 1000);
        }
      }
    }
    
    // Display data in the UI
    function displayData(data) {
      const container = document.getElementById('dataDisplay');
      container.style.display = 'block';
      
      let html = '<div class="section-title" style="margin-bottom: 16px;">ðŸ“Š Received Data</div>';
      
      // Helper function to format data
      function formatData(obj, depth = 0) {
        if (depth > 2) return JSON.stringify(obj); // Prevent infinite recursion
        if (typeof obj !== 'object' || obj === null) return obj;
        
        let result = '';
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === 'object' && value !== null) {
            result += `
              <div class="data-item">
                <div class="data-label">${key}:</div>
                <div class="data-value" style="font-size: 12px; color: #64748b;">
                  ${formatData(value, depth + 1)}
                </div>
              </div>
            `;
          } else {
            result += `
              <div class="data-item">
                <div class="data-label">${key}:</div>
                <div class="data-value">${value}</div>
              </div>
            `;
          }
        }
        return result;
      }
      
      html += formatData(data);
      container.innerHTML = html;
    }
    
    // Update status display
    function updateStatus(status, message) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${status}`;
      
      if (status === 'pending') {
        statusEl.innerHTML = '<div class="spinner"></div><span>' + message + '</span>';
      } else if (status === 'connected') {
        statusEl.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span>${message}</span>
        `;
      } else {
        statusEl.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
          </svg>
          <span>${message}</span>
        `;
      }
      
      connectionStatus = status;
    }
    
    // Add log entry
    function addLog(message, type = 'info') {
      const container = document.getElementById('logContainer');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
      container.prepend(entry);
      
      // Keep only last 50 logs
      const entries = container.querySelectorAll('.log-entry');
      if (entries.length > 50) {
        entries[entries.length - 1].remove();
      }
    }
    
    // Clear all logs
    function clearLogs() {
      document.getElementById('logContainer').innerHTML = '';
      addLog('Logs cleared', 'info');
      showNotification('ðŸ“‹ Logs cleared', 'success');
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const text = document.getElementById('notificationText');
      const icon = notification.querySelector('.notification-icon');
      
      // Set icon based on type
      let iconSvg = '';
      switch (type) {
        case 'success':
          iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
          break;
        case 'error':
          iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';
          break;
        default:
          iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
      }
      
      icon.innerHTML = iconSvg;
      text.textContent = message;
      notification.className = `notification ${type} show`;
      
      // Auto-hide after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Expose functions to global scope for button clicks
    window.testGet = testGet;
    window.testPost = testPost;
    window.clearLogs = clearLogs;
  </script>
</body>
              </html>
