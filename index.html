<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Balance App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { 
  font-family: sans-serif;
  padding:20px; 
  text-align:center;
}
.btn { 
  padding:10px 20px; 
  margin:5px;
  border:none;
  background:#007bff; 
  color:white;
  border-radius:6px;
}
.log {
  background:#000;
  color:#0f0;
  padding:10px;
  height:150px;
  overflow-y:auto;
  text-align:left;
  font-size:12px;
  margin-top:20px;
}
</style>
</head>

<body>
<h2>Hello <span id="name">...</span></h2>
<h1>Balance: <span id="bal">0</span></h1>

<div>
  <button class="btn" onclick="change(-5)">-5</button>
  <button class="btn" onclick="change(5)">+5</button>
</div>

<div>
  <button class="btn" onclick="save()">Save</button>
</div>

<div id="log" class="log"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();

function log(msg){
  let box = document.getElementById("log");
  box.innerHTML += msg + "<br>";
  box.scrollTop = box.scrollHeight;
}

// FIX: Remove Telegram hash part before extracting params
let cleanUrl = location.href.split("#")[0];
let sync = new URL(cleanUrl).searchParams.get("sync");

log("CLEAN URL = " + cleanUrl);
log("SYNC URL = " + sync);

let balance = 0;

async function load(){
  log("Loading user...");

  try {
    let res = await fetch(sync, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"load" })
    });

    let data = await res.json();
    log("Load response: " + JSON.stringify(data));

    if(data.ok){
      document.getElementById("name").textContent = data.user.first_name;
      balance = data.user.balance;
      document.getElementById("bal").textContent = balance;
    } else {
      log("Error: " + data.error);
    }

  } catch (e){
    log("Exception: " + e.message);
  }
}

function change(v){
  balance += v;
  document.getElementById("bal").textContent = balance;
  log("Balance changed to " + balance);
}

async function save(){
  log("Saving balance:", balance);

  try {
    let res = await fetch(sync, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"save", balance })
    });

    let data = await res.json();
    log("Save response: " + JSON.stringify(data));

    if(data.ok){
      tg.showAlert("Saved!");
    } else {
      tg.showAlert("Failed: " + data.error);
    }
  } catch (e){
    log("Exception: " + e.message);
  }
}

load();
</script>
</body>
</html>
