<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Balance WebApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  text-align: center;
  background: #f8f9fa;
}
.container {
  max-width: 380px;
  margin: 0 auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
}
h1 { margin-bottom: 10px; }
.big { font-size: 40px; color: #007bff; font-weight: bold; }
.btn {
  padding: 12px 20px;
  margin: 6px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  color: #fff;
  font-size: 16px;
}
.btn-red { background: #dc3545; }
.btn-green { background: #28a745; }
.btn-blue { background: #007bff; width: 100%; margin-top: 12px; }
#log {
  margin-top: 20px;
  background: #111;
  color: #0f0;
  padding: 10px;
  border-radius: 8px;
  height: 180px;
  overflow-y: auto;
  font-size: 12px;
  text-align: left;
}
</style>
</head>

<body>
<div class="container">
  <h1>Balance WebApp</h1>
  <h2>Hello, <span id="name">Loadingâ€¦</span></h2>

  <div class="big" id="balance">0</div>

  <div>
    <button class="btn btn-red" onclick="change(-5)">-5</button>
    <button class="btn btn-green" onclick="change(5)">+5</button>
  </div>

  <button class="btn btn-blue" onclick="save()">Save Balance</button>

  <div id="log"></div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

// ===============================
// Logging helper
// ===============================
function log(x) {
  document.getElementById("log").innerText += x + "\n";
}

// Extract sync URL
let syncUrl = new URL(location.href).searchParams.get("sync");
log("SYNC URL = " + syncUrl);

let balance = 0;

// ===============================
// LOAD (GET)
// ===============================
function load() {
  log("Sending GET request...");
  fetch(syncUrl)
    .then(r => r.json())
    .then(data => {
      log("GET RESPONSE: " + JSON.stringify(data));
      if (data.success) {
        document.getElementById("name").innerText =
          data.user.first_name || data.user.username || "User";

        balance = parseInt(data.user.balance);
        document.getElementById("balance").innerText = balance;
      } else {
        log("Error loading: " + data.error);
      }
    })
    .catch(err => log("GET ERROR: " + err));
}

// ===============================
// CHANGE
// ===============================
function change(v) {
  balance += v;
  document.getElementById("balance").innerText = balance;
  log("Balance changed to " + balance);
}

// ===============================
// SAVE (POST)
// ===============================
function save() {
  log("Saving... POST " + balance);
  fetch(syncUrl, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ balance: balance })
  })
  .then(r => r.json())
  .then(data => {
    log("POST RESPONSE: " + JSON.stringify(data));
    if (data.success) {
      tg.HapticFeedback.notificationOccurred("success");
    } else {
      tg.HapticFeedback.notificationOccurred("error");
    }
  })
  .catch(err => log("POST ERROR: " + err));
}

load();
</script>
</body>
</html>
