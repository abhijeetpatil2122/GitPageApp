<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Balance Demo</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body { font-family: Arial; text-align:center; padding:20px; }
  .btn { padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; margin:5px; }
</style>
</head>

<body>
<h2>Hello <span id="username">...</span></h2>
<h1>Balance: <span id="balance">0</span></h1>

<button class="btn" onclick="add(-5)">-5</button>
<button class="btn" onclick="add(5)">+5</button>
<br><br>
<button class="btn" onclick="save()">Save</button>

<pre id="log" style="text-align:left; white-space:pre-wrap; margin-top:20px; font-size:12px;"></pre>

<script>
const tg = Telegram.WebApp;
tg.ready();

function log(m){ 
  document.getElementById("log").textContent += m + "\n"; 
}

let sync = new URL(location.href).searchParams.get("sync");
log("SYNC URL = " + sync);

let balance = 0;

// ==========================
// LOAD USER (POST)
// ==========================
function loadUser(){
  log("Sending {action: 'load'}");

  fetch(sync, {
    method:"POST",
    headers:{ "Content-Type": "application/json" },
    body: JSON.stringify({ action:"load" })
  })
  .then(r => r.json())
  .then(d => {
    log("Load response: " + JSON.stringify(d));

    if (!d.ok) { log("Load error"); return; }

    document.getElementById("username").textContent =
      d.user.first_name || d.user.username || "User";

    balance = d.user.balance;
    document.getElementById("balance").textContent = balance;
  })
  .catch(err => log("EXCEPTION(load): " + err));
}

// ==========================
// ADD BALANCE
// ==========================
function add(v){
  balance += v;
  document.getElementById("balance").textContent = balance;
  log("Local balance changed: " + balance);
}

// ==========================
// SAVE BALANCE (POST)
// ==========================
function save(){
  log("Saving balance via POST: " + balance);

  fetch(sync, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ balance })
  })
  .then(r => r.json())
  .then(d => log("SAVE RESPONSE: " + JSON.stringify(d)))
  .catch(err => log("EXCEPTION(save): " + err));
}

// start
loadUser();
</script>
</body>
</html>
