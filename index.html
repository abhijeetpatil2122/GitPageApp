<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#6366f1" />
  <title>Balance Demo</title>
  
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.min.js"></script>
  
  <style>
    :root {
      --primary: #6366f1;
      --success: #10b981;
      --danger: #ef4444;
      --dark: #1f2937;
      --light: #f9fafb;
      --border: #e5e7eb;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1f2937;
    }
    
    .container {
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .card {
      width: 100%;
      max-width: 400px;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      text-align: center;
    }
    
    .header {
      margin-bottom: 30px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      background: var(--primary);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .subtitle {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--light);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 18px;
    }
    
    .user-details {
      text-align: left;
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
    }
    
    .user-id {
      font-size: 12px;
      color: #6b7280;
    }
    
    .balance-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 25px;
      border-radius: 16px;
      margin-bottom: 25px;
      border: 1px solid var(--border);
    }
    
    .balance-label {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .balance {
      font-size: 48px;
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
    }
    
    .balance-currency {
      font-size: 24px;
      color: #94a3b8;
      margin-left: 5px;
    }
    
    .controls {
      margin-bottom: 25px;
    }
    
    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    button {
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }
    
    .save-btn {
      margin-top: 10px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 13px;
      font-weight: 500;
    }
    
    .status.connected {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    
    .status.disconnected {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    .status.pending {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    
    .log {
      margin-top: 20px;
      text-align: left;
    }
    
    .log-title {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .log-entry {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 11px;
      padding: 8px;
      margin-bottom: 6px;
      background: var(--light);
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      word-break: break-all;
    }
    
    .error {
      background: #fef2f2;
      color: #991b1b;
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 14px;
      border-left: 4px solid var(--danger);
    }
    
    .success {
      background: #f0fdf4;
      color: #166534;
      padding: 12px;
      border-radius: 10px;
      margin-top: 15px;
      font-size: 14px;
      border-left: 4px solid var(--success);
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .sync-info {
      font-size: 11px;
      color: #6b7280;
      margin-top: 15px;
      padding: 8px;
      background: var(--light);
      border-radius: 6px;
      border: 1px dashed var(--border);
      word-break: break-all;
    }
    
    .emoji {
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="card">
      <div v-if="loading" class="loading">
        <div class="loading-spinner"></div>
        <span>Loading...</span>
      </div>
      
      <div v-else-if="error" class="error">
        {{ error }}
        <button class="btn-primary" @click="retry" style="margin-top: 10px; background: var(--danger);">
          Retry Connection
        </button>
      </div>
      
      <div v-else>
        <div class="header">
          <div class="logo">üí∞</div>
          <h1>{{ botName }}</h1>
          <div class="subtitle">Balance Demo - GitHub Pages + BB Bot</div>
        </div>
        
        <div class="user-info">
          <div class="user-avatar">
            {{ user.first_name ? user.first_name[0] : 'U' }}
          </div>
          <div class="user-details">
            <div class="user-name">{{ user.first_name || user.username || 'User' }}</div>
            <div class="user-id">ID: {{ user.id }}</div>
          </div>
        </div>
        
        <div class="balance-section">
          <div class="balance-label">Current Balance</div>
          <div class="balance">
            {{ user.balance }}
            <span class="balance-currency">üíé</span>
          </div>
        </div>
        
        <div class="controls">
          <div class="btn-group">
            <button class="btn-danger" @click="changeBalance(-10)" :disabled="user.balance < 10">
              <span class="emoji">‚ûñ</span>
              <span>-10</span>
            </button>
            <button class="btn-danger" @click="changeBalance(-5)" :disabled="user.balance < 5">
              <span class="emoji">‚ûñ</span>
              <span>-5</span>
            </button>
            <button class="btn-success" @click="changeBalance(5)">
              <span class="emoji">‚ûï</span>
              <span>+5</span>
            </button>
            <button class="btn-success" @click="changeBalance(10)">
              <span class="emoji">‚ûï</span>
              <span>+10</span>
            </button>
          </div>
          
          <button class="btn-primary save-btn" @click="saveBalance" :disabled="saving || !hasChanges">
            <span v-if="saving">
              <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
              Saving...
            </span>
            <span v-else>
              <span class="emoji">üíæ</span>
              Save Balance {{ hasChanges ? '*' : '' }}
            </span>
          </button>
        </div>
        
        <div class="status" :class="connectionStatus">
          <span v-if="connectionStatus === 'connected'" class="emoji">‚úÖ</span>
          <span v-else-if="connectionStatus === 'disconnected'" class="emoji">‚ùå</span>
          <span v-else class="emoji">üîÑ</span>
          <span>{{ statusMessage }}</span>
        </div>
        
        <div v-if="successMessage" class="success">
          {{ successMessage }}
        </div>
        
        <div class="sync-info">
          <div>Webhook URL: {{ syncUrl ? 'Loaded' : 'Missing' }}</div>
          <div v-if="syncUrl" style="font-size: 9px; margin-top: 4px; opacity: 0.7;">
            {{ syncUrl.substring(0, 50) }}...
          </div>
        </div>
        
        <div v-if="logs.length > 0" class="log">
          <div class="log-title">Activity Log</div>
          <div v-for="(log, index) in logs.slice(0, 3)" :key="index" class="log-entry">
            {{ log }}
          </div>
          <div v-if="logs.length > 3" style="font-size: 10px; color: #6b7280; text-align: center; margin-top: 5px;">
            ... and {{ logs.length - 3 }} more entries
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  const { createApp, ref, reactive, computed, onMounted } = Vue;
  
  createApp({
    setup() {
      // Initialize Telegram WebApp
      const tg = window.Telegram?.WebApp || null;
      if (tg) {
        try {
          tg.ready();
          tg.expand();
          tg.setHeaderColor('#6366f1');
          tg.setBackgroundColor('#667eea');
        } catch (e) {
          console.warn('Telegram WebApp init failed:', e);
        }
      }
      
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const syncUrl = urlParams.get('sync');
      const botName = urlParams.get('botName') || 'Balance Demo';
      const userId = urlParams.get('userId');
      const username = urlParams.get('username') || 'User';
      
      // State
      const user = reactive({
        id: userId,
        username: username,
        first_name: username,
        balance: 0,
        originalBalance: 0
      });
      
      const loading = ref(true);
      const saving = ref(false);
      const error = ref('');
      const successMessage = ref('');
      const logs = reactive([]);
      const connectionStatus = ref('pending');
      const statusMessage = ref('Connecting...');
      
      // Computed properties
      const hasChanges = computed(() => {
        return user.balance !== user.originalBalance;
      });
      
      // Helper functions
      function addLog(message) {
        const time = new Date().toLocaleTimeString();
        logs.unshift(`[${time}] ${message}`);
        if (logs.length > 20) logs.pop();
        console.log(message);
      }
      
      function updateStatus(status, message) {
        connectionStatus.value = status;
        statusMessage.value = message;
      }
      
      function showSuccess(msg) {
        successMessage.value = msg;
        setTimeout(() => {
          successMessage.value = '';
        }, 3000);
        
        // Haptic feedback
        if (tg?.HapticFeedback) {
          try {
            tg.HapticFeedback.notificationOccurred('success');
          } catch (e) {}
        }
      }
      
      function showError(msg) {
        error.value = msg;
        
        // Haptic feedback
        if (tg?.HapticFeedback) {
          try {
            tg.HapticFeedback.notificationOccurred('error');
          } catch (e) {}
        }
      }
      
      function retry() {
        error.value = '';
        loading.value = true;
        loadUserData();
      }
      
      // API functions
      async function loadUserData() {
        if (!syncUrl) {
          showError('‚ùå No sync URL provided. Please open this app from your Telegram bot using the /start command.');
          loading.value = false;
          updateStatus('disconnected', 'No sync URL');
          return;
        }
        
        updateStatus('pending', 'Loading data...');
        addLog('Loading user data from bot...');
        
        try {
          const response = await fetch(syncUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          addLog(`GET Response: HTTP ${response.status}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          addLog(`GET Success: ${data.message || 'Data loaded'}`);
          
          if (!data.success) {
            throw new Error(data.error || 'Failed to load data');
          }
          
          // Update user data
          if (data.user) {
            user.id = data.user.id || userId;
            user.username = data.user.username || username;
            user.first_name = data.user.first_name || username;
            user.balance = parseInt(data.user.balance || 0, 10);
            user.originalBalance = user.balance;
          }
          
          updateStatus('connected', 'Connected to bot');
          showSuccess('‚úÖ Data loaded successfully!');
          loading.value = false;
          
        } catch (err) {
          console.error('Load failed:', err);
          showError(`Failed to load data: ${err.message}`);
          updateStatus('disconnected', 'Connection failed');
          loading.value = false;
        }
      }
      
      async function saveBalance() {
        if (!hasChanges.value) {
          showSuccess('No changes to save');
          return;
        }
        
        if (!syncUrl) {
          showError('No sync URL available');
          return;
        }
        
        saving.value = true;
        addLog(`Saving balance: ${user.balance}`);
        
        try {
          // BB expects POST data to be sent as JSON object
          const postData = {
            balance: user.balance
          };
          
          const response = await fetch(syncUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(postData)
          });
          
          addLog(`POST Response: HTTP ${response.status}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          addLog(`POST Success: ${data.message || 'Balance saved'}`);
          
          if (!data.success) {
            throw new Error(data.error || 'Failed to save balance');
          }
          
          // Update original balance
          user.originalBalance = user.balance;
          
          showSuccess('‚úÖ Balance saved successfully!');
          updateStatus('connected', 'Data synced');
          
        } catch (err) {
          console.error('Save failed:', err);
          showError(`Failed to save: ${err.message}`);
          updateStatus('disconnected', 'Sync failed');
          
        } finally {
          saving.value = false;
        }
      }
      
      function changeBalance(amount) {
        const newBalance = user.balance + amount;
        
        if (newBalance < 0) {
          showError('Balance cannot be negative');
          
          // Haptic feedback
          if (tg?.HapticFeedback) {
            try {
              tg.HapticFeedback.notificationOccurred('warning');
            } catch (e) {}
          }
          
          return;
        }
        
        user.balance = newBalance;
        addLog(`Balance changed: ${amount > 0 ? '+' : ''}${amount} = ${user.balance}`);
        
        // Haptic feedback
        if (tg?.HapticFeedback) {
          try {
            tg.HapticFeedback.impactOccurred('light');
          } catch (e) {}
        }
      }
      
      // Initialize
      onMounted(() => {
        addLog('App initialized');
        addLog(`Bot: ${botName}`);
        addLog(`User ID: ${userId || 'Unknown'}`);
        addLog(`Sync URL: ${syncUrl ? 'Found' : 'Missing'}`);
        
        if (!syncUrl) {
          showError('Please open this app from your Telegram bot using the /start command.');
          loading.value = false;
          return;
        }
        
        loadUserData();
      });
      
      return {
        // State
        user,
        loading,
        saving,
        error,
        successMessage,
        logs,
        connectionStatus,
        statusMessage,
        
        // Computed
        hasChanges,
        
        // Data
        botName,
        syncUrl,
        
        // Methods
        changeBalance,
        saveBalance,
        retry
      };
    }
  }).mount('#app');
  </script>
</body>
          </html>
