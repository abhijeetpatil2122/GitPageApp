<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Balance WebApp Demo</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Vue 3 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.min.js"></script>

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
    }
    html,body { height:100%; margin:0; background:var(--bg); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text) }
    .wrap { max-width:720px; margin:24px auto; padding:16px; }
    .card { background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,0.06); }
    h1 { margin:0 0 8px; font-size:20px; }
    p.muted { color:var(--muted); margin:0 0 12px; }
    .balance { font-size:48px; font-weight:700; color:var(--accent); margin:8px 0 16px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    button { border:0; padding:10px 14px; border-radius:10px; cursor:pointer; color:#fff; font-weight:600; }
    .btn-accent { background:var(--accent); }
    .btn-danger { background:#ef4444; }
    .btn-ghost { background:transparent; color:var(--accent); border:1px solid #e5e7eb; }
    .log { margin-top:14px; font-family:monospace; background:#0f172a; color:#fff; padding:12px; border-radius:8px; max-height:220px; overflow:auto; font-size:13px; }
    .row { display:flex; gap:8px; align-items:center; }
    .small { font-size:13px; color:var(--muted) }
  </style>
</head>
<body>
  <div id="app" class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <h1 id="title">Balance WebApp</h1>
          <div class="small" id="sub">Demo 2-way sync with Bots.Business webhooks</div>
        </div>
        <div>
          <button class="btn-ghost" @click="debugCopySync">Copy sync URL</button>
        </div>
      </div>

      <p class="muted">Hello, <strong>{{ userName }}</strong></p>

      <div class="balance">{{ balance }}</div>

      <div class="controls">
        <button class="btn-danger" @click="change(-10)">-10</button>
        <button class="btn-danger" @click="change(-5)">-5</button>
        <button class="btn-accent" @click="change(5)">+5</button>
        <button class="btn-accent" @click="change(10)">+10</button>
        <button style="margin-left:auto" class="btn-accent" @click="save" :disabled="saving">
          {{ saving ? 'Saving...' : 'Save' }}
        </button>
      </div>

      <div style="margin-top:12px" class="small">
        <strong>Sync URL:</strong> <span style="word-break:break-all">{{ sync }}</span>
      </div>

      <div class="log" id="log">
        <div v-for="(l,i) in logs" :key="i">{{ l }}</div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand?.(); } catch(e){ /* ignore */ }

    const app = Vue.createApp({
      data() {
        return {
          sync: "",         // webhook URL (from ?sync=)
          botName: "",
          balance: 0,
          userName: "User",
          saving: false,
          logs: []
        }
      },
      created() {
        // read query params
        const p = new URLSearchParams(window.location.search);
        this.sync = p.get('sync') || p.get('syncUrl') || "";
        this.botName = p.get('botName') || document.title || "WebApp";
        document.getElementById('title').textContent = this.botName + " ‚Äî Balance";

        this.log("CLEAN URL: " + window.location.href);
        this.log("SYNC URL = " + this.sync);

        if (!this.sync) {
          this.log("‚ùå No sync URL provided in query string. Provide ?sync=<url>");
          return;
        }

        // load user via POST (action: load)
        this.load();
      },
      methods: {
        log(...args) {
          const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
          this.logs.unshift(new Date().toLocaleTimeString() + "  " + s);
          if (this.logs.length > 200) this.logs.length = 200;
          // also console.log
          console.log(...args);
        },

        async fetchJson(postBody) {
          // centralized fetch with debug logs; always POST
          try {
            this.log("‚Üí POST to webhook:", postBody);
            const res = await fetch(this.sync, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(postBody)
            });

            // read text first for debug (some servers return HTML on error)
            const text = await res.text();
            this.log("‚Üê HTTP", res.status, "content-type:", res.headers.get('content-type'));
            this.log("‚Üê RAW:", text.slice(0, 800));

            // try parse JSON
            try {
              const json = JSON.parse(text);
              this.log("‚Üê JSON:", json);
              return { ok: true, res, json };
            } catch (err) {
              this.log("‚ö†Ô∏è Server did not return JSON:", err.message);
              return { ok: false, res, text };
            }

          } catch (err) {
            this.log("üö´ Fetch error:", err.message);
            return { ok: false, error: err };
          }
        },

        async load() {
          this.log("Loading user (POST { action: 'load' })...");
          const r = await this.fetchJson({ action: "load" });

          if (!r.ok) {
            this.log("‚ùå Load failed:", r.error || r.text || r.res?.status);
            return;
          }

          const data = r.json;
          if (data && (data.ok === true || data.success === true)) {
            // data may be { ok: true, user: {...} } or success:true
            const user = data.user || data.user || {};
            this.balance = parseInt(user.balance || 0, 10);
            this.userName = user.username || user.first_name || "Player";
            this.log("Loaded user:", user);
            // gentle haptic if available
            try { tg?.HapticFeedback?.impactOccurred("light"); } catch(e){}
            return;
          }

          this.log("‚ùå Unexpected load response:", data);
        },

        change(delta) {
          this.balance = parseInt(this.balance || 0, 10) + delta;
          this.log("Balance changed to", this.balance);
          try { tg?.HapticFeedback?.impactOccurred("selection"); } catch(e){}
        },

        async save() {
          if (!this.sync) {
            this.log("‚ùå Missing sync URL");
            return;
          }
          this.saving = true;
          this.log("Saving balance to webhook (POST):", this.balance);

          const r = await this.fetchJson({ balance: this.balance });

          if (!r.ok) {
            this.log("‚ùå Save failed:", r.error || r.text || r.res?.status);
            this.saving = false;
            return;
          }

          const json = r.json;
          if (json && (json.ok === true || json.success === true)) {
            this.log("‚úÖ Save response:", json);
            try { tg?.HapticFeedback?.notificationOccurred("success"); } catch(e){}
            try { tg?.showAlert("Saved!"); } catch(e){}
          } else {
            this.log("‚ùå Unexpected save response:", json);
            try { tg?.HapticFeedback?.notificationOccurred("error"); } catch(e){}
          }

          this.saving = false;
        },

        debugCopySync() {
          if (!this.sync) return;
          navigator.clipboard?.writeText(this.sync).then(()=> {
            this.log("Sync URL copied to clipboard.");
            try { tg?.showAlert("Sync URL copied"); } catch(e){}
          }).catch(()=> this.log("Failed to copy sync URL."));
        }
      }
    });

    app.mount('#app');
  </script>
</body>
  </html>
