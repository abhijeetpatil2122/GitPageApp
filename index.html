<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Balance App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body { 
  font-family: sans-serif;
  padding:20px; 
  text-align:center;
}
.btn { 
  padding:10px 20px; 
  margin:5px;
  border:none;
  background:#007bff; 
  color:white;
  border-radius:6px;
}
.log {
  font-size: 12px;
  color: #444;
  margin-top: 15px;
  white-space: pre-wrap;
  text-align: left;
}
</style>
</head>

<body>
<h2>Hello <span id="name">User</span></h2>
<h1>Balance: <span id="bal">0</span></h1>

<div>
  <button class="btn" onclick="change(-5)">-5</button>
  <button class="btn" onclick="change(5)">+5</button>
</div>

<div>
  <button class="btn" onclick="save()">Save</button>
</div>

<div class="log" id="logBox"></div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();

// -------- LOGGER --------
function log(msg){
  console.log(msg);
  document.getElementById("logBox").textContent += msg + "\n";
}

// -------- SYNC URL DETECTION --------
let syncUrl = null;

// 1️⃣ Try Telegram initDataUnsafe.start_param
if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
  syncUrl = tg.initDataUnsafe.start_param;
  log("Got sync URL from start_param:");
  log(syncUrl);
}

// 2️⃣ Fallback: URL hash (#encodedURL)
if (!syncUrl && location.hash.length > 1) {
  syncUrl = decodeURIComponent(location.hash.substring(1));
  log("Got sync URL from HASH:");
  log(syncUrl);
}

// 3️⃣ Fallback: Query param (browser preview only)
if (!syncUrl) {
  syncUrl = new URL(location.href).searchParams.get("sync");
  if (syncUrl) {
    log("Got sync URL from query param:");
    log(syncUrl);
  }
}

if (!syncUrl) {
  log("❌ ERROR: No sync URL available!");
  tg.showAlert("No sync URL provided!");
}

// -------- BALANCE LOGIC --------
let balance = 0;

// Load user data
function load(){
  log("Loading user data...");
  fetch(syncUrl, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"load" })
  })
  .then(r => r.json())
  .then(d => {
    log("Load response:");
    log(JSON.stringify(d, null, 2));

    document.getElementById("name").textContent = d.user.first_name || "User";
    balance = d.user.balance;
    document.getElementById("bal").textContent = balance;
  })
  .catch(err => {
    log("❌ Load error: " + err);
  });
}

function change(v){
  balance += v;
  document.getElementById("bal").textContent = balance;
  tg.HapticFeedback?.impactOccurred("light");
  log("Balance changed to " + balance);
}

function save(){
  log("Saving balance: " + balance);
  fetch(syncUrl, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"save", balance })
  })
  .then(r => r.json())
  .then(d => {
    log("Save response:");
    log(JSON.stringify(d, null, 2));
    tg.showAlert("Saved!");
    tg.HapticFeedback?.notificationOccurred("success");
  })
  .catch(err => {
    log("❌ Save error: " + err);
    tg.HapticFeedback?.notificationOccurred("error");
  });
}

load();
</script>

</body>
</html>
